<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music V20</title>
    
    <!-- PWA Settings -->
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Music Pro">
    
    <!-- Icons/Manifest -->
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2111/2111624.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2111/2111624.png">
    <link id="manifest-link" rel="manifest" href="">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { background-color: #000; color: #fff; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Slider Spotify-like */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
            height: 4px;
            border-radius: 2px;
            cursor: pointer;
            width: 100%;
            background-image: linear-gradient(to right, #1ed760 0%, #1ed760 0%, #404040 0%, #404040 100%);
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #fff;
            margin-top: -4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            opacity: 1;
        }
        
        .glass { background: rgba(18, 18, 18, 0.95); border-bottom: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden selection:bg-green-500 selection:text-black">

    <!-- HEADER -->
    <header class="glass z-20 shrink-0 sticky top-0">
        <div class="flex justify-between items-center p-4">
            <div class="flex items-center gap-2">
                <div class="bg-green-500 rounded-full p-1.5"><i data-lucide="music" class="w-4 h-4 text-black fill-current"></i></div>
                <h1 class="font-bold text-lg tracking-tight">Music <span class="text-[10px] text-zinc-500 border border-zinc-800 px-1 rounded ml-1 font-normal">V20</span></h1>
            </div>
            <!-- Botão Configurações -->
            <button onclick="document.getElementById('settings-modal').classList.remove('hidden')" class="text-zinc-400 hover:text-white transition p-2">
                <i data-lucide="settings" class="w-5 h-5"></i>
            </button>
        </div>
        
        <!-- ABAS -->
        <div class="flex text-xs font-bold uppercase tracking-wider border-b border-white/10">
            <button onclick="switchTab('library')" id="tab-library" class="flex-1 py-4 text-white border-b-2 border-green-500 transition bg-white/5">
                Biblioteca
            </button>
            <button onclick="switchTab('search')" id="tab-search" class="flex-1 py-4 text-zinc-500 border-b-2 border-transparent transition hover:bg-white/5">
                Buscar
            </button>
        </div>
    </header>

    <!-- STATUS BAR (Offline Warning) -->
    <div id="offline-bar" class="hidden bg-red-900/90 text-white text-[10px] text-center py-1 font-bold animate-pulse">
        Sem conexão. Modo offline ativo.
    </div>

    <!-- MAIN AREA -->
    <main class="flex-1 overflow-hidden relative bg-[#121212]">
        
        <!-- 1. BIBLIOTECA -->
        <div id="view-library" class="h-full overflow-y-auto p-4 no-scrollbar pb-40">
            
            <!-- Controles -->
            <div class="flex gap-2 mb-6">
                <button onclick="openCreatePlaylistModal()" class="flex-1 bg-[#282828] py-3 rounded-lg text-xs font-bold hover:bg-white hover:text-black transition flex items-center justify-center gap-2 border border-white/5">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i> Criar Playlist
                </button>
                <button onclick="document.getElementById('file-upload').click()" class="flex-1 bg-[#282828] py-3 rounded-lg text-xs font-bold hover:bg-white hover:text-black transition flex items-center justify-center gap-2 border border-white/5">
                    <i data-lucide="folder-up" class="w-4 h-4"></i> Importar MP3
                </button>
            </div>

            <!-- Seção Playlists -->
            <div id="playlist-section" class="mb-6 hidden">
                <h3 class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest mb-2 px-1">Playlists</h3>
                <ul id="playlist-list" class="space-y-1"></ul>
            </div>
            
            <!-- Seção Músicas -->
            <div class="flex justify-between items-center mb-2 px-1">
                <h3 class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">Músicas Baixadas</h3>
                <span id="total-songs" class="text-[10px] bg-[#282828] px-2 py-0.5 rounded text-zinc-400">0</span>
            </div>
            
            <div id="library-empty" class="hidden flex flex-col items-center justify-center py-12 text-zinc-600 text-center border-2 border-dashed border-zinc-800 rounded-xl mt-4">
                <i data-lucide="hard-drive" class="w-12 h-12 mb-3 opacity-30"></i>
                <p class="text-sm font-bold text-zinc-400">Biblioteca Vazia</p>
                <p class="text-xs mt-1 max-w-[200px]">Use a busca para baixar músicas ou importe seus arquivos.</p>
            </div>

            <ul id="song-list" class="space-y-1 pb-10"></ul>
        </div>

        <!-- 2. BUSCA -->
        <div id="view-search" class="h-full overflow-y-auto p-4 no-scrollbar pb-40 hidden">
            <div class="sticky top-0 bg-[#121212] z-10 pb-4 pt-1">
                <div class="relative group">
                    <i data-lucide="search" class="absolute left-3.5 top-3 text-zinc-500 w-5 h-5 group-focus-within:text-white transition"></i>
                    <input type="text" id="search-input" placeholder="O que você quer ouvir?" 
                        class="w-full bg-[#282828] text-white pl-10 pr-4 py-3 rounded-full font-medium placeholder-zinc-500 outline-none text-sm focus:ring-2 focus:ring-white transition shadow-lg">
                </div>
            </div>

            <div id="search-loader" class="hidden flex flex-col items-center justify-center py-20">
                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-green-500"></div>
                <p class="text-xs text-zinc-500 mt-3">Pesquisando no iTunes...</p>
            </div>

            <ul id="search-results" class="space-y-2 pb-10"></ul>
        </div>
    </main>

    <!-- PLAYER FIXO -->
    <footer class="fixed bottom-0 w-full bg-[#181818] border-t border-white/5 p-2 pb-safe z-40 shadow-2xl">
        <!-- Barra de Progresso (Corrigida) -->
        <div class="w-full flex items-center gap-2 mb-1 px-1 select-none">
            <span id="current-time" class="text-[10px] text-zinc-400 font-mono min-w-[30px] text-right">0:00</span>
            <div class="relative flex-1 h-4 flex items-center group">
                <input type="range" min="0" max="100" value="0" id="seek-slider" class="absolute w-full h-full opacity-100 z-10 cursor-pointer">
            </div>
            <span id="duration" class="text-[10px] text-zinc-400 font-mono min-w-[30px]">0:00</span>
        </div>

        <div class="flex items-center justify-between px-1">
            <div class="flex items-center gap-3 flex-1 min-w-0 pr-2">
                <img id="p-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23282828'%3E%3Crect width='24' height='24'/%3E%3C/svg%3E" class="w-10 h-10 rounded object-cover bg-[#282828]">
                <div class="min-w-0">
                    <h4 id="p-title" class="text-sm font-bold text-white truncate">Music V20</h4>
                    <p id="p-artist" class="text-[10px] text-zinc-400 truncate">GitHub Ready</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <button onclick="prev()" class="text-zinc-400 hover:text-white transition active:scale-90"><i data-lucide="skip-back" class="w-6 h-6 fill-current"></i></button>
                <button onclick="toggle()" class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-black hover:scale-105 transition shadow-lg">
                    <i id="play-icon" data-lucide="play" class="w-5 h-5 fill-current ml-0.5"></i>
                </button>
                <button onclick="next()" class="text-zinc-400 hover:text-white transition active:scale-90"><i data-lucide="skip-forward" class="w-6 h-6 fill-current"></i></button>
            </div>
        </div>
    </footer>

    <!-- MODAIS -->
    
    <!-- Playlist View -->
    <div id="playlist-overlay" class="fixed inset-0 bg-[#121212] z-30 hidden overflow-y-auto pb-32">
        <div class="bg-gradient-to-b from-green-900/40 to-[#121212] p-4 pt-10 sticky top-0 z-10 backdrop-blur-md border-b border-white/5">
            <div class="flex items-center gap-4">
                <button onclick="closePlaylist()" class="p-2 bg-black/20 rounded-full hover:bg-black/40"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                <h1 class="text-xl font-bold truncate flex-1" id="pl-title">Playlist</h1>
                <button onclick="deleteCurrentPlaylist()" class="text-zinc-400 hover:text-red-500 bg-black/20 p-2 rounded-full"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
            </div>
            <div class="mt-4 flex gap-2">
                <button onclick="playPlaylistContext()" class="bg-green-500 text-black px-6 py-2 rounded-full font-bold text-sm hover:scale-105 transition shadow-lg flex items-center gap-2">
                    <i data-lucide="play" class="w-4 h-4 fill-current"></i> Tocar Tudo
                </button>
            </div>
        </div>
        <ul id="pl-songs" class="px-4 pt-4 space-y-1"></ul>
    </div>

    <!-- Add to Playlist -->
    <div id="add-to-modal" class="fixed inset-0 bg-black/90 z-[60] hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-[#222] w-full max-w-sm rounded-xl p-4 shadow-2xl border border-white/10">
            <h2 class="font-bold text-lg mb-4 text-center">Adicionar à Playlist</h2>
            <div id="playlist-select-list" class="space-y-2 max-h-60 overflow-y-auto mb-4 no-scrollbar"></div>
            <button onclick="document.getElementById('add-to-modal').classList.add('hidden')" class="w-full py-3 font-bold text-sm text-zinc-400 hover:text-white border-t border-white/5 mt-2">Cancelar</button>
        </div>
    </div>

    <!-- Create Playlist -->
    <div id="create-pl-modal" class="fixed inset-0 bg-black/90 z-[60] hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-[#222] w-full max-w-sm rounded-xl p-4 shadow-2xl border border-white/10">
            <h2 class="font-bold text-lg mb-4">Nova Playlist</h2>
            <input type="text" id="new-pl-name" class="w-full bg-[#111] text-white p-3 rounded border border-white/10 outline-none mb-4 focus:border-green-500 transition" placeholder="Nome...">
            <div class="flex gap-2">
                <button onclick="document.getElementById('create-pl-modal').classList.add('hidden')" class="flex-1 py-2 text-sm text-zinc-400 hover:text-white">Cancelar</button>
                <button onclick="confirmCreatePlaylist()" class="flex-1 bg-green-500 py-2 rounded text-black font-bold text-sm hover:bg-green-400">Criar</button>
            </div>
        </div>
    </div>

    <!-- Manual Download -->
    <div id="manual-dl-modal" class="fixed inset-0 bg-black/90 z-[70] hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-[#222] w-full max-w-sm rounded-xl p-5 shadow-2xl border border-white/10 text-center">
            <div class="bg-yellow-500/10 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-500"></i>
            </div>
            <h2 class="font-bold text-lg mb-2">Automático Falhou</h2>
            <p class="text-xs text-zinc-400 mb-6">O servidor não encontrou esta música. Baixe manualmente:</p>
            
            <button id="ext-dl-btn" class="block w-full bg-green-500 text-black py-3 rounded-lg font-bold text-sm mb-2 hover:bg-green-400 transition flex items-center justify-center gap-2">
                <i data-lucide="external-link" class="w-4 h-4"></i> 1. Buscar no Google
            </button>
            <button onclick="document.getElementById('manual-dl-modal').classList.add('hidden'); document.getElementById('file-upload').click()" class="block w-full bg-[#333] text-white py-3 rounded-lg font-bold text-sm border border-white/5 hover:bg-[#444] transition">
                2. Importar o Arquivo
            </button>
            <button onclick="document.getElementById('manual-dl-modal').classList.add('hidden')" class="mt-4 text-xs text-zinc-500">Cancelar</button>
        </div>
    </div>

    <!-- Settings -->
    <div id="settings-modal" class="fixed inset-0 bg-black/90 z-[70] hidden flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-[#222] w-full max-w-sm rounded-xl p-5 shadow-2xl border border-white/10">
            <h2 class="font-bold mb-4">Configuração</h2>
            <p class="text-xs text-zinc-400 mb-2">Servidor de download:</p>
            <select id="server-select" class="w-full bg-[#111] text-white p-3 rounded mt-1 border border-white/10 outline-none text-sm mb-4">
                <option value="https://jiosaavn-api-privatecvc2.vercel.app">Servidor 1 (Vercel) - Padrão</option>
                <option value="https://saavn.dev/api">Servidor 2 (Dev)</option>
            </select>
            <button onclick="saveSettings()" class="w-full bg-green-500 hover:bg-green-400 text-black font-bold py-3 rounded-lg transition">Salvar</button>
        </div>
    </div>

    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 bg-[#333] border border-white/10 text-white px-4 py-2 rounded-full font-bold text-xs shadow-xl z-[80] hidden opacity-0 transition-opacity flex items-center gap-2 whitespace-nowrap">
        <span id="toast-msg">Info</span>
    </div>

    <input type="file" id="file-upload" multiple accept="audio/*" class="hidden">
    <audio id="audio" crossorigin="anonymous"></audio>

    <script>
        // CONFIG
        const ITUNES_API = "https://itunes.apple.com/search";
        const PROXY = "https://corsproxy.io/?"; 
        let currentServer = localStorage.getItem('audio_server') || "https://jiosaavn-api-privatecvc2.vercel.app";
        document.getElementById('server-select').value = currentServer;

        // DB
        let db, songs=[], playlists=[], queue=[], currentIndex=0, isPlaying=false, currentPlaylistId=null;
        
        const initDB = () => new Promise(r => {
            const req = indexedDB.open('MusicV20GitHub', 1);
            req.onupgradeneeded = e => {
                const db = e.target.result;
                db.createObjectStore('songs', { keyPath: 'id' });
                db.createObjectStore('playlists', { keyPath: 'id', autoIncrement: true });
            };
            req.onsuccess = e => { db = e.target.result; r(); };
        });

        // NETWORK CHECK
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        function updateOnlineStatus() {
            if(!navigator.onLine) document.getElementById('offline-bar').classList.remove('hidden');
            else document.getElementById('offline-bar').classList.add('hidden');
        }

        // SEARCH (Debounced)
        let searchTimer;
        document.getElementById('search-input').addEventListener('input', e => {
            clearTimeout(searchTimer);
            // 800ms debounce
            searchTimer = setTimeout(() => performSearch(e.target.value.trim()), 800);
        });
        // Enter key force search
        document.getElementById('search-input').addEventListener('keypress', e => {
            if(e.key === 'Enter') {
                clearTimeout(searchTimer);
                performSearch(e.target.value.trim());
            }
        });

        async function performSearch(query) {
            if(!query) return;
            if(!navigator.onLine) return showToast("Sem conexão com a internet.");

            const list = document.getElementById('search-results');
            const loader = document.getElementById('search-loader');
            list.innerHTML = '';
            loader.classList.remove('hidden');

            try {
                // AllOrigins Proxy for iTunes (CORS safety)
                const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`${ITUNES_API}?term=${query}&media=music&entity=song&limit=15`)}`);
                const data = await res.json();
                const json = JSON.parse(data.contents);
                loader.classList.add('hidden');

                if(json.resultCount === 0) return list.innerHTML = '<p class="text-zinc-500 text-center mt-10 text-xs">Nada encontrado.</p>';

                json.results.forEach(t => {
                    const hdImg = t.artworkUrl100.replace('100x100','400x400');
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 p-2 rounded hover:bg-[#282828] group transition border-b border-white/5';
                    div.innerHTML = `
                        <img src="${hdImg}" class="w-12 h-12 rounded bg-[#333] object-cover shadow-sm">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-white text-sm truncate">${t.trackName}</h4>
                            <p class="text-xs text-zinc-400 truncate">${t.artistName}</p>
                        </div>
                        <button onclick="downloadFull('${t.trackName.replace(/'/g, "")}', '${t.artistName.replace(/'/g, "")}', '${hdImg}', this)" class="bg-[#333] hover:bg-green-600 hover:text-black text-white p-2 rounded-full transition shadow-lg">
                            <i data-lucide="arrow-down" class="w-4 h-4"></i>
                        </button>
                    `;
                    list.appendChild(div);
                });
                lucide.createIcons();
            } catch(e) { loader.classList.add('hidden'); }
        }

        // DOWNLOAD
        async function downloadFull(title, artist, img, btn) {
            const oldIcon = btn.innerHTML;
            btn.innerHTML = '<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>';
            btn.disabled = true;
            
            showToast("Buscando...", 2000);
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);

            try {
                // Sanitização da busca
                const query = `${title} ${artist}`.trim();
                const searchRes = await fetch(`${PROXY}${encodeURIComponent(`${currentServer}/search/songs?query=${query}&limit=1`)}`, { signal: controller.signal });
                const data = await searchRes.json();
                
                const results = data.data?.results || data.data || data.results;
                if(!results || !results.length) throw new Error("Não encontrado");
                
                const song = results[0];
                let url = null;
                if(song.downloadUrl) {
                    const best = song.downloadUrl.find(d => d.quality === '320kbps') || song.downloadUrl[song.downloadUrl.length-1];
                    url = best.url || best.link;
                }
                if(!url) throw new Error("Link vazio");

                showToast("Baixando...", 5000);
                const dlRes = await fetch(`${PROXY}${encodeURIComponent(url)}`, { signal: controller.signal });
                if(!dlRes.ok) throw new Error("Erro rede");
                const blob = await dlRes.blob();
                
                if(blob.size < 500000) throw new Error("Arquivo incompleto");

                const file = new File([blob], `${title}.mp4`, { type: blob.type });
                const tx = db.transaction(['songs'], 'readwrite');
                tx.objectStore('songs').add({
                    id: crypto.randomUUID(), title, artist, cover: img, file, added: Date.now()
                });
                
                showToast("Salvo!");
                btn.className = "bg-white text-black p-2 rounded-full shadow-lg";
                btn.innerHTML = '<i data-lucide="check" class="w-4 h-4"></i>';
                lucide.createIcons();
                loadLibrary();

            } catch(e) {
                // Fallback Manual
                const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(`${title} ${artist} mp3 download`)}`;
                const extBtn = document.getElementById('ext-dl-btn');
                extBtn.onclick = () => window.open(searchUrl, '_blank');
                
                document.getElementById('manual-dl-modal').classList.remove('hidden');
                document.getElementById('manual-dl-modal').classList.add('flex');
                
                btn.innerHTML = '<i data-lucide="x" class="w-4 h-4 text-red-500"></i>';
                setTimeout(() => { btn.innerHTML = oldIcon; btn.disabled = false; lucide.createIcons(); }, 2000);
            }
            clearTimeout(timeoutId);
        }

        // LIBRARY
        function loadLibrary() {
            const tx = db.transaction(['songs', 'playlists'], 'readonly');
            
            tx.objectStore('songs').getAll().onsuccess = e => {
                songs = e.target.result.sort((a,b) => b.added - a.added);
                document.getElementById('total-songs').innerText = songs.length;
                const list = document.getElementById('song-list');
                list.innerHTML = '';
                
                if(!songs.length) document.getElementById('library-empty').classList.remove('hidden');
                else document.getElementById('library-empty').classList.add('hidden');

                songs.forEach((s, idx) => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center gap-3 p-2 hover:bg-[#282828] rounded cursor-pointer group border-b border-white/5';
                    li.onclick = (e) => {
                        if(e.target.closest('.action-btn')) return;
                        playLocal(idx);
                    };
                    
                    li.innerHTML = `
                        <img src="${s.cover}" class="w-10 h-10 rounded bg-[#333] object-cover">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-white text-sm truncate ${s.title === document.getElementById('p-title').innerText ? 'text-green-500' : ''}">${s.title}</h4>
                            <p class="text-[10px] text-zinc-400 truncate">${s.artist}</p>
                        </div>
                        <button onclick="event.stopPropagation(); openAddToModal('${s.id}')" class="action-btn text-zinc-500 hover:text-white p-2"><i data-lucide="plus-circle" class="w-4 h-4"></i></button>
                        <button onclick="event.stopPropagation(); deleteSong('${s.id}')" class="action-btn text-zinc-500 hover:text-red-500 p-2"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    `;
                    list.appendChild(li);
                });
                lucide.createIcons();
            };

            tx.objectStore('playlists').getAll().onsuccess = e => {
                const plList = document.getElementById('playlist-list');
                plList.innerHTML = '';
                if(e.target.result.length > 0) {
                    document.getElementById('playlist-section').classList.remove('hidden');
                    e.target.result.forEach(pl => {
                        const li = document.createElement('li');
                        li.className = 'flex items-center gap-3 p-2 bg-[#1a1a1a] rounded hover:bg-[#2a2a2a] cursor-pointer mb-1 border border-white/5';
                        li.onclick = () => openPlaylist(pl.id);
                        li.innerHTML = `<div class="w-10 h-10 bg-gradient-to-br from-green-900 to-black rounded flex items-center justify-center"><i data-lucide="list-music" class="w-4 h-4 text-green-500"></i></div><div class="flex-1"><h4 class="font-bold text-xs">${pl.name}</h4><p class="text-[10px] text-zinc-500">${pl.songs.length} músicas</p></div><i data-lucide="chevron-right" class="w-4 h-4 text-zinc-600"></i>`;
                        plList.appendChild(li);
                    });
                } else {
                    document.getElementById('playlist-section').classList.add('hidden');
                }
            }
        }

        // PLAYER LOGIC
        const audio = document.getElementById('audio');
        function playLocal(idx) {
            if (!currentPlaylistId) queue = songs;
            currentIndex = idx;
            const song = queue[idx];
            if(!song) return;

            updatePlayerInfo(song.title, song.artist, song.cover);
            if(audio.src) URL.revokeObjectURL(audio.src);
            audio.src = URL.createObjectURL(song.file);
            audio.play();
            updatePlayBtn(true);
        }

        function updatePlayerInfo(t, a, i) {
            document.getElementById('p-title').innerText = t;
            document.getElementById('p-artist').innerText = a;
            document.getElementById('p-img').src = i;
        }
        function updatePlayBtn(p) {
            isPlaying = p;
            const icon = document.getElementById('play-icon');
            if(p) { icon.setAttribute('data-lucide', 'pause'); icon.classList.remove('ml-0.5'); }
            else { icon.setAttribute('data-lucide', 'play'); icon.classList.add('ml-0.5'); }
            lucide.createIcons();
        }
        function toggle() { if(audio.paused && audio.src) audio.play(); else audio.pause(); }
        function prev() { if(queue.length) playLocal(currentIndex > 0 ? currentIndex - 1 : queue.length - 1); }
        function next() { if(queue.length) playLocal(currentIndex < queue.length - 1 ? currentIndex + 1 : 0); }

        audio.onplay = () => updatePlayBtn(true);
        audio.onpause = () => updatePlayBtn(false);
        audio.onended = () => next();
        
        // CORREÇÃO DO TEMPO (Metadata + Timeupdate)
        audio.onloadedmetadata = () => {
            const dur = audio.duration;
            if(isFinite(dur)) document.getElementById('duration').textContent = fmtTime(dur);
        };

        audio.ontimeupdate = () => {
            const dur = audio.duration;
            if(dur && isFinite(dur)) {
                const pct = (audio.currentTime / dur) * 100;
                const slider = document.getElementById('seek-slider');
                slider.value = pct;
                slider.style.backgroundImage = `linear-gradient(to right, #1ed760 0%, #1ed760 ${pct}%, #404040 ${pct}%, #404040 100%)`;
                
                document.getElementById('current-time').textContent = fmtTime(audio.currentTime);
                // Fallback para atualizar duração caso loadedmetadata falhe
                document.getElementById('duration').textContent = fmtTime(dur);
            }
        };
        
        document.getElementById('seek-slider').oninput = (e) => {
            if(audio.duration) audio.currentTime = (e.target.value / 100) * audio.duration;
        };

        // UTILS
        function switchTab(t) {
            ['library','search'].forEach(v => {
                document.getElementById(`view-${v}`).classList.add('hidden');
                const btn = document.getElementById(`tab-${v}`);
                if(v===t) { btn.classList.add('text-white','border-green-500','bg-white/5'); btn.classList.remove('text-zinc-500','border-transparent'); }
                else { btn.classList.remove('text-white','border-green-500','bg-white/5'); btn.classList.add('text-zinc-500','border-transparent'); }
            });
            document.getElementById(`view-${t}`).classList.remove('hidden');
            if(t === 'library') loadLibrary();
        }

        function deleteSong(id) {
            if(confirm("Tem certeza?")) {
                const tx = db.transaction(['songs'], 'readwrite');
                tx.objectStore('songs').delete(id).onsuccess = () => {
                    // Clean playlists
                    const plTx = db.transaction(['playlists'], 'readwrite');
                    const plStore = plTx.objectStore('playlists');
                    plStore.getAll().onsuccess = e => {
                        e.target.result.forEach(pl => {
                            if(pl.songs.includes(id)) { pl.songs = pl.songs.filter(x => x !== id); plStore.put(pl); }
                        });
                        loadLibrary();
                        showToast("Apagado.");
                    };
                };
            }
        }

        // Playlist & Import
        function openCreatePlaylistModal() { document.getElementById('create-pl-modal').classList.remove('hidden'); document.getElementById('create-pl-modal').classList.add('flex'); }
        function confirmCreatePlaylist() {
            const name = document.getElementById('new-pl-name').value;
            if(name) db.transaction(['playlists'], 'readwrite').objectStore('playlists').add({ name, songs: [] }).onsuccess = () => {
                document.getElementById('create-pl-modal').classList.remove('flex'); document.getElementById('create-pl-modal').classList.add('hidden'); loadLibrary();
            };
        }
        async function openPlaylist(id) {
            currentPlaylistId = id;
            const tx = db.transaction(['playlists', 'songs'], 'readonly');
            const pl = await new Promise(r => tx.objectStore('playlists').get(id).onsuccess = e => r(e.target.result));
            const allSongs = await new Promise(r => tx.objectStore('songs').getAll().onsuccess = e => r(e.target.result));
            document.getElementById('pl-title').innerText = pl.name;
            const list = document.getElementById('pl-songs'); list.innerHTML = '';
            queue = pl.songs.map(sid => allSongs.find(s => s.id === sid)).filter(Boolean);
            queue.forEach((s, idx) => {
                const li = document.createElement('li');
                li.className = 'flex items-center gap-3 p-2 hover:bg-[#282828] rounded cursor-pointer border-b border-white/5';
                li.onclick = (e) => { if(e.target.closest('.rem')) removeFromPlaylist(id, s.id); else { currentIndex=idx; playLocal(idx); }};
                li.innerHTML = `<img src="${s.cover}" class="w-10 h-10 rounded object-cover"><div class="flex-1 min-w-0"><h4 class="text-white text-xs font-bold truncate">${s.title}</h4><p class="text-[10px] text-zinc-400">${s.artist}</p></div><button class="rem text-zinc-600 hover:text-red-500 bg-black/40 p-2 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>`;
                list.appendChild(li);
            });
            document.getElementById('playlist-overlay').classList.remove('hidden');
            lucide.createIcons();
        }
        function closePlaylist() { document.getElementById('playlist-overlay').classList.add('hidden'); currentPlaylistId = null; }
        function deleteCurrentPlaylist() { if(confirm("Apagar playlist?")) db.transaction(['playlists'], 'readwrite').objectStore('playlists').delete(currentPlaylistId).onsuccess = () => { closePlaylist(); loadLibrary(); }; }
        function removeFromPlaylist(pid, sid) { const tx = db.transaction(['playlists'], 'readwrite'); const st = tx.objectStore('playlists'); st.get(pid).onsuccess = e => { const pl=e.target.result; pl.songs=pl.songs.filter(id=>id!==sid); st.put(pl).onsuccess = () => openPlaylist(pid); }; }
        function openAddToModal(sid) {
            const list = document.getElementById('playlist-select-list'); list.innerHTML='';
            db.transaction(['playlists'], 'readonly').objectStore('playlists').getAll().onsuccess = e => {
                if(!e.target.result.length) return alert("Crie uma playlist primeiro!");
                e.target.result.forEach(pl => {
                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left p-3 bg-[#333] mb-1 rounded text-sm hover:bg-[#444] flex justify-between';
                    const has = pl.songs.includes(sid);
                    btn.innerHTML = `<span>${pl.name}</span> ${has ? '<i data-lucide="check" class="w-4 h-4 text-green-500"></i>' : ''}`;
                    if(!has) { btn.onclick = () => { const tx = db.transaction(['playlists'], 'readwrite'); const st = tx.objectStore('playlists'); st.get(pl.id).onsuccess = ev => { const d=ev.target.result; d.songs.push(sid); st.put(d); showToast("Adicionado!"); document.getElementById('add-to-modal').classList.add('hidden'); }; }; } else btn.style.opacity = '0.5';
                    list.appendChild(btn);
                });
                document.getElementById('add-to-modal').classList.remove('hidden'); document.getElementById('add-to-modal').classList.add('flex'); lucide.createIcons();
            };
        }

        document.getElementById('file-upload').onchange = (e) => {
            const tx = db.transaction(['songs'], 'readwrite');
            for(const f of e.target.files) tx.objectStore('songs').add({ id: crypto.randomUUID(), title: f.name.replace(/\.[^/.]+$/, ""), artist: 'Local', cover: 'https://via.placeholder.com/150', file: f, added: Date.now() });
            tx.oncomplete = () => { loadLibrary(); showToast("Importado!"); };
        };

        function showToast(msg, duration=2000) { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; t.classList.remove('hidden'); requestAnimationFrame(() => t.classList.remove('opacity-0')); setTimeout(() => { t.classList.add('opacity-0'); setTimeout(() => t.classList.add('hidden'), 300); }, duration); }
        function saveSettings() { localStorage.setItem('audio_server', document.getElementById('server-select').value); currentServer = document.getElementById('server-select').value; document.getElementById('settings-modal').classList.add('hidden'); showToast("Salvo!"); }
        function fmtTime(s) { if(isNaN(s) || !isFinite(s)) return "0:00"; const m = Math.floor(s/60); const sc = Math.floor(s%60); return `${m}:${sc.toString().padStart(2,'0')}`; }

        // Init
        (async () => {
            await initDB(); loadLibrary(); lucide.createIcons();
            const m={name:"Music V18",display:"standalone",background_color:"#000",icons:[{src:"https://cdn-icons-png.flaticon.com/512/2111/2111624.png",sizes:"512x512",type:"image/png"}]};
            document.getElementById('manifest-link').href=URL.createObjectURL(new Blob([JSON.stringify(m)],{type:'application/json'}));
        })();
    </script>
</body>
</html>
